<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm" (click)="onClose()">
  <div class="relative w-full max-w-4xl h-[80vh] mx-4 bg-white dark:bg-gray-900 rounded-lg shadow-xl flex overflow-hidden" (click)="$event.stopPropagation()">
    
    <!-- Left Panel: Stepper -->
    <div class="w-1/3 bg-gray-50 dark:bg-gray-800 p-8 border-r border-gray-200 dark:border-gray-700 hidden sm:block">
      <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">{{ flow()?.name }}</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-8">{{ flow()?.description }}</p>
      <nav class="space-y-4">
        @for (step of steps(); track step.stepId; let i = $index) {
          <a class="flex items-start p-3 rounded-md transition-colors" 
             [class.bg-indigo-100]="i === currentStepIndex()"
             [class.dark:bg-indigo-900/50]="i === currentStepIndex()">
            <div class="flex-shrink-0 mr-4 mt-1">
              @if (i < currentStepIndex() || flowState().status === 'completed' || flowState().status === 'final-result') {
                <div class="w-6 h-6 rounded-full bg-indigo-600 flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              } @else {
                <div class="w-6 h-6 rounded-full flex items-center justify-center"
                     [class.bg-indigo-600]="i === currentStepIndex()"
                     [class.text-white]="i === currentStepIndex()"
                     [class.bg-gray-200]="i > currentStepIndex()"
                     [class.dark:bg-gray-700]="i > currentStepIndex()"
                     [class.dark:text-gray-400]="i > currentStepIndex()">
                  <span class="text-sm font-bold">{{ i + 1 }}</span>
                </div>
              }
            </div>
            <div>
              <p class="font-semibold"
                 [class.text-indigo-700]="i <= currentStepIndex()"
                 [class.dark:text-indigo-400]="i <= currentStepIndex()"
                 [class.text-gray-500]="i > currentStepIndex()"
                 [class.dark:text-gray-400]="i > currentStepIndex()">
                {{ step.title }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ step.description }}</p>
            </div>
          </a>
        }
      </nav>
    </div>

    <!-- Right Panel: Content -->
    <div class="w-full sm:w-2/3 p-6 md:p-8 flex flex-col overflow-y-auto">
      @if (flowState(); as state) {
        @switch (state.status) {
          @case ('loading') {
            <div class="flex flex-col items-center justify-center h-full">
              <svg class="w-12 h-12 text-indigo-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">Processing...</p>
            </div>
          }
  
          @case ('ready') {
            @if (state.currentStep; as currentStep) {
              <div class="flex-grow">
                <header class="pb-4 mb-6 border-b border-gray-200 dark:border-gray-700">
                  <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ currentStep.title }}</h2>
                  <p class="mt-1 text-gray-500 dark:text-gray-400">{{ currentStep.description }}</p>
                </header>
                
                <form [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" class="space-y-5">
                  @for (field of currentStep.formFields; track field.key) {
                    <div class="flex flex-col">
                      <label [for]="field.key" class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                        {{ field.label }}
                        @if (field.required) {
                          <span class="ml-1 text-red-500">*</span>
                        }
                      </label>
  
                      @switch (field.type) {
                        @case ('textarea') {
                          <textarea [id]="field.key" [formControlName]="field.key" rows="4" class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                        }
                        @case ('select') {
                          <div class="relative">
                            <select [id]="field.key" [formControlName]="field.key" class="block w-full pl-3 pr-10 py-2 text-base bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md disabled:bg-gray-200 dark:disabled:bg-gray-800 disabled:cursor-not-allowed">
                              <option value="" disabled selected>
                                @if (fieldLoading()[field.key]) {
                                  Loading...
                                } @else if (dynamicForm.get(field.key)?.disabled) {
                                   Select {{ field.dependencyKey }} first
                                } @else {
                                  -- Select an option --
                                }
                              </option>
                              @if (fieldOptions()[field.key]; as options) {
                                @for(option of options; track option.value) {
                                  <option [value]="option.value">{{ option.label }}</option>
                                }
                              }
                            </select>
                            @if(fieldLoading()[field.key]) {
                              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                              </div>
                            }
                          </div>
                        }
                        @default {
                          <input [type]="field.type" [id]="field.key" [formControlName]="field.key" class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        }
                      }
                      @if (dynamicForm.get(field.key)?.invalid && dynamicForm.get(field.key)?.touched) {
                        <p class="mt-1 text-xs text-red-500">This field is required.</p>
                      }
                    </div>
                  }
                  
                  @if(currentStep.formFields.length === 0) {
                    <div class="py-4 text-center text-gray-500 dark:text-gray-400">
                        <p>This is a confirmation step. Click "{{ isStepWithFinalQuery() ? 'Finish & Run Query' : (isSubmittingFinalStep() ? 'Finish' : 'Next') }}" to continue.</p>
                    </div>
                  }
                </form>
              </div>
              
              <footer class="flex justify-between items-center pt-6 mt-auto border-t border-gray-200 dark:border-gray-700">
                  <div>
                      @if (!isFirstStep()) {
                        <button type="button" (click)="onBack()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                          Back
                        </button>
                      }
                  </div>
                  <div class="space-x-3">
                    <button type="button" (click)="onClose()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                      Cancel
                    </button>
                    <button type="button" (click)="onSubmit()" [disabled]="dynamicForm.invalid" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                      @if (isStepWithFinalQuery()) {
                          <span>Finish & Run Query</span>
                      } @else if (isSubmittingFinalStep()) {
                          <span>Finish</span>
                      } @else {
                          <span>Next</span>
                      }
                    </button>
                  </div>
              </footer>
            }
          }

          @case ('final-result') {
            <div class="m-auto text-center flex-grow flex flex-col">
                <header class="pb-4 mb-6 border-b border-gray-200 dark:border-gray-700 text-left">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Query Executed Successfully!</h2>
                    <p class="mt-1 text-gray-500 dark:text-gray-400">The final query has been processed. Below are the results.</p>
                </header>
                <div class="flex-grow bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-left overflow-auto">
                    <pre class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap"><code>{{ state.finalQueryResult | json }}</code></pre>
                </div>
                <footer class="flex justify-end items-center pt-6 mt-auto">
                    <button (click)="onClose()" class="inline-flex justify-center px-6 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Close
                    </button>
                </footer>
            </div>
          }
  
          @case ('completed') {
            <div class="m-auto text-center">
              <svg class="w-16 h-16 mx-auto text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <h2 class="mt-4 text-2xl font-bold text-gray-900 dark:text-white">Flow Completed!</h2>
              <p class="mt-2 text-gray-600 dark:text-gray-300">The process has been successfully completed.</p>
              <button (click)="onClose()" class="inline-flex justify-center px-6 py-2 mt-6 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Close
              </button>
            </div>
          }
  
          @case ('error') {
            <div class="m-auto text-center">
              <svg class="w-16 h-16 mx-auto text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
              <h2 class="mt-4 text-2xl font-bold text-gray-900 dark:text-white">An Error Occurred</h2>
              <p class="mt-2 text-gray-600 dark:text-gray-300">{{ state.error }}</p>
              <button (click)="onClose()" class="inline-flex justify-center px-6 py-2 mt-6 text-sm font-medium text-white bg-gray-600 border border-transparent rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Close
              </button>
            </div>
          }
        }
      }
    </div>
  </div>
</div>
