
<div class="p-4 sm:p-6 md:p-8 border rounded-lg bg-white dark:bg-gray-800 shadow-sm min-h-[70vh]">
  <header class="mb-6 border-b border-gray-200 dark:border-gray-700 pb-4">
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Query Designer</h2>
    <p class="text-gray-500 dark:text-gray-400 mt-1">Create, edit, and manage the reusable data queries that power your flows.</p>
  </header>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    
    <!-- Column 1: Queries List -->
    <div class="md:col-span-1 border-r border-gray-200 dark:border-gray-700 pr-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200">Available Queries</h3>
        <button (click)="addNewQuery()" class="bg-purple-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-purple-700 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
          New Query
        </button>
      </div>

      <div class="space-y-2">
        @for(query of queries(); track query.name) {
          <div 
            [class.bg-indigo-100]="selectedQueryName() === query.name && !showQueryForm()"
            [class.dark:bg-indigo-900/50]="selectedQueryName() === query.name && !showQueryForm()"
            class="w-full text-left p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 flex justify-between items-center">
            
            <div (click)="selectQuery(query)" class="flex-grow cursor-pointer flex items-center min-w-0">
              @if(query.locked) {
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-yellow-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
              }
              <div class="min-w-0">
                <span class="font-semibold text-gray-800 dark:text-gray-100 font-mono truncate">{{ query.name }}</span>
                 @if(query.isCatalog) {
                    <span class="ml-2 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2 py-0.5 rounded-full">Catalog</span>
                } @else {
                    <span class="ml-2 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 px-2 py-0.5 rounded-full">Final</span>
                }
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate">{{ query.description }}</p>
              </div>
            </div>

             <div class="relative flex-shrink-0 ml-2">
                <button (click)="toggleActionsMenu(query.name)" title="Actions" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-400 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                    </svg>
                </button>
                @if (actionsMenuOpenForQuery() === query.name) {
                    <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-xl z-10 border dark:border-gray-600">
                        <div class="py-1">
                            <button (click)="editQuery(query); toggleActionsMenu(query.name)" [disabled]="query.locked" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                              <span>Edit Query</span>
                            </button>
                            <button (click)="toggleLock(query.name); toggleActionsMenu(query.name)" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center gap-3">
                                @if(query.locked) {
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm0 8h.01V12H10V10zM12 2H8a3 3 0 00-3 3v2h6V5a3 3 0 00-3-3z" /></svg>
                                    <span>Unlock Query</span>
                                } @else {
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                                    <span>Lock Query</span>
                                }
                            </button>
                            <button (click)="requestDeleteQuery(query); toggleActionsMenu(query.name)" [disabled]="query.locked" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/50 flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                <span>Delete Query</span>
                            </button>
                        </div>
                    </div>
                }
             </div>
          </div>
        } @empty {
            <p class="text-gray-500 italic text-center py-4">No queries defined yet.</p>
        }
      </div>
    </div>

    <!-- Column 2: Query Editor / Details -->
    <div class="md:col-span-2">
      @if (showQueryForm()) {
        <!-- Query Editor Form -->
        <div class="p-4 border-l-4 border-purple-500 bg-gray-50 dark:bg-gray-800/50 rounded-r-lg">
          <h4 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">
            {{ isEditing() ? 'Edit Query' : 'Add New Query' }}
          </h4>
          <form [formGroup]="queryForm" (ngSubmit)="saveQuery()" class="space-y-6">
            <!-- General Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="q-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Query Name</label>
                <input type="text" id="q-name" formControlName="name" placeholder="e.g., GET_USERS_BY_DEPT" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:bg-gray-200 dark:disabled:bg-gray-700/50">
                @if(queryForm.get('name')?.invalid && queryForm.get('name')?.touched) {
                  <p class="text-red-500 text-xs mt-1">Name is required (UPPERCASE, numbers, underscores).</p>
                }
              </div>
              <div>
                <label for="q-endpoint" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Endpoint</label>
                <input type="text" id="q-endpoint" formControlName="targetEndpoint" placeholder="e.g., USERS or /api/v1/users" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                 @if(queryForm.get('targetEndpoint')?.invalid && queryForm.get('targetEndpoint')?.touched) {
                    @if(queryForm.get('targetEndpoint')?.hasError('required')) {
                      <p class="text-red-500 text-xs mt-1">Endpoint is required.</p>
                    }
                    @if(queryForm.get('targetEndpoint')?.hasError('pattern')) {
                      <p class="text-red-500 text-xs mt-1">Must be an uppercase ID (e.g. USERS) or a valid path (e.g. /api/v1/users).</p>
                    }
                  }
              </div>
            </div>
             <div>
              <label for="q-desc" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
              <textarea id="q-desc" formControlName="description" rows="2" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
               @if(queryForm.get('description')?.invalid && queryForm.get('description')?.touched) {
                  <p class="text-red-500 text-xs mt-1">Description is required.</p>
                }
            </div>
            <div class="flex items-center">
              <input id="q-isCatalog" type="checkbox" formControlName="isCatalog" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              <label for="q-isCatalog" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Is Catalog (for populating dropdowns)</label>
            </div>

            <!-- Parameters Section -->
            <div formArrayName="parameters" class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex justify-between items-center mb-2">
                <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Parameters</h5>
                 <button type="button" (click)="addParameter()" class="bg-indigo-600 text-white font-semibold py-1 px-3 rounded-md hover:bg-indigo-700 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                  Add Parameter
                </button>
              </div>

              <div class="space-y-4">
                @for (paramGroup of parameters.controls; track $index) {
                  <div [formGroupName]="$index" class="p-3 grid grid-cols-1 sm:grid-cols-4 gap-3 border border-gray-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-900/50 relative">
                    <button type="button" (click)="removeParameter($index)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center hover:bg-red-600">&times;</button>
                    <div>
                      <label [for]="'p-key-' + $index" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Key</label>
                      <input type="text" [id]="'p-key-' + $index" formControlName="key" class="mt-1 block w-full px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded-md">
                    </div>
                     <div>
                      <label [for]="'p-label-' + $index" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Label</label>
                      <input type="text" [id]="'p-label-' + $index" formControlName="label" class="mt-1 block w-full px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded-md">
                    </div>
                    <div>
                      <label [for]="'p-type-' + $index" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Type</label>
                      <select [id]="'p-type-' + $index" formControlName="type" class="mt-1 block w-full px-2 py-1 text-sm bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded-md">
                        @for (type of parameterTypes; track type) {
                          <option [value]="type">{{type}}</option>
                        }
                      </select>
                    </div>
                    <div class="flex items-end pb-1">
                      <div class="flex items-center">
                        <input [id]="'p-req-' + $index" type="checkbox" formControlName="required" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label [for]="'p-req-' + $index" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Required</label>
                      </div>
                    </div>
                  </div>
                } @empty {
                  <p class="text-gray-500 italic text-sm text-center py-2">No parameters defined.</p>
                }
              </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" (click)="cancelForm()" class="bg-white dark:bg-gray-600 py-2 px-4 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
              <button type="submit" [disabled]="queryForm.invalid" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:bg-gray-400 disabled:cursor-not-allowed">Save Query</button>
            </div>
          </form>
        </div>
      } @else if (selectedQuery(); as query) {
        <!-- Query Details View -->
        <div class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-2xl font-bold font-mono text-gray-800 dark:text-gray-100 flex items-center">
                  @if(query.locked) {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                  }
                  {{ query.name }}
                </h4>
                <p class="text-gray-500 dark:text-gray-400 mt-1">{{ query.description }}</p>
              </div>
            </div>
            <div class="mt-6 space-y-4">
              <div class="flex items-center">
                <strong class="w-32 text-gray-500 dark:text-gray-400 text-sm">Type</strong>
                 @if(query.isCatalog) {
                    <span class="text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2 py-0.5 rounded-full">Catalog</span>
                } @else {
                    <span class="text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 px-2 py-0.5 rounded-full">Final</span>
                }
              </div>
              <div class="flex items-center">
                <strong class="w-32 text-gray-500 dark:text-gray-400 text-sm">Endpoint</strong>
                <code class="text-sm bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded-md">{{query.targetEndpoint}}</code>
              </div>
            </div>
             <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3">Parameters</h5>
                 @for(param of query.parameters; track param.key) {
                    <div class="grid grid-cols-4 gap-2 text-sm mb-2 p-2 bg-white dark:bg-gray-800 rounded">
                        <div class="font-mono text-gray-700 dark:text-gray-300"><strong class="text-gray-500 dark:text-gray-400">Key:</strong> {{param.key}}</div>
                        <div class="text-gray-700 dark:text-gray-300"><strong class="text-gray-500 dark:text-gray-400">Label:</strong> {{param.label}}</div>
                        <div class="text-gray-700 dark:text-gray-300"><strong class="text-gray-500 dark:text-gray-400">Type:</strong> {{param.type}}</div>
                        <div class="text-gray-700 dark:text-gray-300"><strong class="text-gray-500 dark:text-gray-400">Required:</strong> {{param.required ? 'Yes' : 'No'}}</div>
                    </div>
                 } @empty {
                    <p class="text-gray-500 italic text-sm">This query has no parameters.</p>
                 }
            </div>
        </div>
      } @else {
        <div class="flex items-center justify-center h-full rounded-lg bg-gray-50 dark:bg-gray-900/50 min-h-[40vh]">
          <p class="text-gray-500 italic text-lg">Select a query to see its details, or create a new one.</p>
        </div>
      }
    </div>

  </div>
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm" (click)="cancelDelete()">
    <div class="relative w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 dark:text-white">Confirm Deletion</h3>
      <div class="mt-2">
        @if(queryToDelete(); as query) {
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Are you sure you want to permanently delete the query 
            <strong class="font-mono text-purple-600 dark:text-purple-400">{{ query.name }}</strong>? 
            This action cannot be undone.
          </p>
        }
      </div>
      <div class="mt-6 flex justify-end space-x-3">
        <button (click)="cancelDelete()" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          Cancel
        </button>
        <button (click)="confirmDelete()" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
          Delete Query
        </button>
      </div>
    </div>
  </div>
}
